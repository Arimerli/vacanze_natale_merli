<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dettaglio Partita</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <a href="/" class="back">â† Indietro</a>

    {% if partita %}
    <div class="card">
        <span class="status {{ partita['stato'] }}" id="stato">{{ partita['stato'].upper() }}</span>

        <div class="players" id="players">
            {{ partita["giocatore1"] }} vs {{ partita["giocatore2"] }}
        </div>

        <div class="sets" id="sets">
            {% if len(partita["punteggioset1"]) > 0 %}
            <div class="set">
                <div class="set-title">Set 1</div>
                <div class="set-score" id="set1">{{ partita["punteggioset1"][0] }} - {{ partita["punteggioset1"][1] }}</div>
            </div>
            {% end %}

            {% if len(partita["punteggioset2"]) > 0 %}
            <div class="set">
                <div class="set-title">Set 2</div>
                <div class="set-score" id="set2">{{ partita["punteggioset2"][0] }} - {{ partita["punteggioset2"][1] }}</div>
            </div>
            {% end %}

            {% if len(partita["punteggioset3"]) > 0 %}
            <div class="set">
                <div class="set-title">Set 3</div>
                <div class="set-score" id="set3">{{ partita["punteggioset3"][0] }} - {{ partita["punteggioset3"][1] }}</div>
            </div>
            {% end %}
        </div>

        <div class="winner" id="winner" style="display: {% if partita.get('vincitore') %}block{% else %}none{% end %};">
            {% if partita.get("vincitore") %}
            ğŸ† Vincitore: {{ partita["vincitore"] }}
            {% end %}
        </div>

        <div class="info">
            <div class="info-row">
                <span>Tempo di gioco:</span>
                <strong id="minutaggio">{{ partita["minutaggio"] }} minuti</strong>
            </div>
        </div>
    </div>

    <script>
        const PARTITA_ID = "{{ partita['_id'] }}";
        const ws = new WebSocket('ws://localhost:8888/ws');

        ws.onopen = function() {
            console.log('WebSocket connesso per partita:', PARTITA_ID);
        };

        ws.onmessage = function(event) {
            const partite = JSON.parse(event.data);

            // Trova solo la partita corrente
            const partitaCorrente = partite.find(p => {
                const id = p._id.$oid || p._id;
                return id.toString() === PARTITA_ID.toString();
            });

            if (partitaCorrente) {
                aggiornaDettaglioPartita(partitaCorrente);
            }
        };

        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };

        ws.onclose = function() {
            console.log('WebSocket chiuso');
        };

        function aggiornaDettaglioPartita(partita) {
            // Aggiorna lo stato
            const statoEl = document.getElementById('stato');
            statoEl.textContent = partita.stato.toUpperCase();
            statoEl.className = 'status ' + partita.stato;

            // Aggiorna i set
            const setsContainer = document.getElementById('sets');
            let setsHtml = '';

            if (partita.punteggioset1 && partita.punteggioset1.length > 0) {
                setsHtml += `
                    <div class="set">
                        <div class="set-title">Set 1</div>
                        <div class="set-score">${partita.punteggioset1[0]} - ${partita.punteggioset1[1]}</div>
                    </div>
                `;
            }

            if (partita.punteggioset2 && partita.punteggioset2.length > 0) {
                setsHtml += `
                    <div class="set">
                        <div class="set-title">Set 2</div>
                        <div class="set-score">${partita.punteggioset2[0]} - ${partita.punteggioset2[1]}</div>
                    </div>
                `;
            }

            if (partita.punteggioset3 && partita.punteggioset3.length > 0) {
                setsHtml += `
                    <div class="set">
                        <div class="set-title">Set 3</div>
                        <div class="set-score">${partita.punteggioset3[0]} - ${partita.punteggioset3[1]}</div>
                    </div>
                `;
            }

            setsContainer.innerHTML = setsHtml;

            // Aggiorna vincitore
            const winnerEl = document.getElementById('winner');
            if (partita.vincitore) {
                winnerEl.textContent = `ğŸ† Vincitore: ${partita.vincitore}`;
                winnerEl.style.display = 'block';
            } else {
                winnerEl.style.display = 'none';
            }

            // Aggiorna minutaggio
            document.getElementById('minutaggio').textContent = `${partita.minutaggio} minuti`;
        }
    </script>

    {% else %}
    <div class="card">
        <h2>Partita non trovata</h2>
    </div>
    {% end %}
</body>
</html>