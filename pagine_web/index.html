<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<h1>TennSI</h1>

<div class="container" id="partite-container">
    {% for partita in partite %}
        <div class="sensor-box light" onclick="window.location.href='./selezionato?id={{ partita["_id"] }}'">
            <h3>{{ partita['giocatore1'] }} VS {{ partita['giocatore2'] }}</h3>
            <h4>{{ partita['stato'] }}</h4>
            <div class="set-scores">
                {% if len(partita['punteggioset1']) > 0 %}
                    <div class="set_index">
                        <div class="score">{{ partita['punteggioset1'][0] }}</div>
                        <div class="score">{{ partita['punteggioset1'][1] }}</div>
                    </div>
                {% end %}
                {% if len(partita['punteggioset2']) > 0 %}
                    <div class="set_index">
                        <div class="score">{{ partita['punteggioset2'][0] }}</div>
                        <div class="score">{{ partita['punteggioset2'][1] }}</div>
                    </div>
                {% end %}
                {% if len(partita['punteggioset3']) > 0 %}
                    <div class="set_index">
                        <div class="score">{{ partita['punteggioset3'][0] }}</div>
                        <div class="score">{{ partita['punteggioset3'][1] }}</div>
                    </div>
                {% end %}
            </div>
        </div>
    {% end %}
</div>

<script>
    const ws = new WebSocket('ws://localhost:8888/ws');

    ws.onopen = function() {
        console.log('WebSocket connesso');
    };

    ws.onmessage = function(event) {
        const partite = JSON.parse(event.data);
        aggiornaPartite(partite);
    };

    ws.onerror = function(error) {
        console.error('WebSocket error:', error);
    };

    ws.onclose = function() {
        console.log('WebSocket chiuso');
    };

    function aggiornaPartite(partite) {
        const container = document.getElementById('partite-container');
        if (!container) return;

        // Costruisci l'HTML per tutte le partite
        let html = '';

        partite.forEach(partita => {
            html += `
                <div class="sensor-box light" onclick="window.location.href='./selezionato?id=${partita._id.$oid || partita._id}'">
                    <h3>${partita.giocatore1} VS ${partita.giocatore2}</h3>
                    <h4>${partita.stato}</h4>
                    <div class="set-scores">
            `;

            // Set 1
            if (partita.punteggioset1 && partita.punteggioset1.length > 0) {
                html += `
                    <div class="set_index">
                        <div class="score">${partita.punteggioset1[0]}</div>
                        <div class="score">${partita.punteggioset1[1]}</div>
                    </div>
                `;
            }

            // Set 2
            if (partita.punteggioset2 && partita.punteggioset2.length > 0) {
                html += `
                    <div class="set_index">
                        <div class="score">${partita.punteggioset2[0]}</div>
                        <div class="score">${partita.punteggioset2[1]}</div>
                    </div>
                `;
            }

            // Set 3
            if (partita.punteggioset3 && partita.punteggioset3.length > 0) {
                html += `
                    <div class="set_index">
                        <div class="score">${partita.punteggioset3[0]}</div>
                        <div class="score">${partita.punteggioset3[1]}</div>
                    </div>
                `;
            }

            html += `
                    </div>
                </div>
            `;
        });

        // Aggiorna il contenuto SENZA ricaricare la pagina
        container.innerHTML = html;
    }
</script>

</body>
</html>
